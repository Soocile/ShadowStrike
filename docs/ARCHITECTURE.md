# ShadowStrike Antivirus - Enterprise Architecture Guide

```
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
 â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•  
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•
```

**Version:** 1.0.0  
**Last Updated:** January 14, 2026  
**Status:** Infrastructure Complete - Core Engine Development Phase  
**Target:** Enterprise-grade Antivirus (CrowdStrike/Kaspersky Quality)

---

## Table of Contents

1. [High-Level Architecture Overview](#1-high-level-architecture-overview)
2. [Module Organization](#2-module-organization)
3. [SignatureStore System](#3-signaturestore-system)
4. [HashStore System](#4-hashstore-system)
5. [PatternStore System](#5-patternstore-system)
6. [ThreatIntel System](#6-threatintel-system)
7. [Whitelist System (Dual-Layer)](#7-whitelist-system-dual-layer)
8. [Database System (SQLite)](#8-database-system-sqlite)
9. [Utils (Utility Library)](#9-utils-utility-library)
10. [Memory Management Strategy](#10-memory-management-strategy)
11. [Thread Safety Model](#11-thread-safety-model)
12. [Performance Targets](#12-performance-targets)
13. [File Format Specifications](#13-file-format-specifications)
14. [Future Core Engine Components](#14-future-core-engine-components)
15. [Build System](#15-build-system)

---

## 1. High-Level Architecture Overview

### 1.1 System Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    PRESENTATION LAYER                                    â”‚
â”‚                              (GUI - Qt/WinUI - NOT YET IMPLEMENTED)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    APPLICATION LAYER                                     â”‚
â”‚                            (Core Engine - NOT YET IMPLEMENTED)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ScanEngine   â”‚ â”‚ BehaviorMon  â”‚ â”‚ RealTimeProt â”‚ â”‚ NetworkMon   â”‚ â”‚ QuarantineMgrâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    DATA ACCESS LAYER                                     â”‚
â”‚                              (INFRASTRUCTURE - IMPLEMENTED âœ“)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚SignatureStoreâ”‚ â”‚  HashStore   â”‚ â”‚ PatternStore â”‚ â”‚ ThreatIntel  â”‚ â”‚  Whitelist   â”‚  â”‚
â”‚  â”‚   (mmap)     â”‚ â”‚   (mmap)     â”‚ â”‚   (mmap)     â”‚ â”‚   (mmap)     â”‚ â”‚ (mmap+SQLite)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    PERSISTENCE LAYER                                     â”‚
â”‚                              (INFRASTRUCTURE - IMPLEMENTED âœ“)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ ConfigDB     â”‚ â”‚   LogDB      â”‚ â”‚ QuarantineDB â”‚ â”‚   Utils      â”‚                    â”‚
â”‚  â”‚  (SQLite)    â”‚ â”‚  (SQLite)    â”‚ â”‚  (SQLite)    â”‚ â”‚   Library    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Current Implementation Status

| Component | Status | Lines of Code | Notes |
|-----------|--------|---------------|-------|
| SignatureStore | âœ… Complete | ~25,000 | Memory-mapped, B+Tree, YARA |
| HashStore | âœ… Complete | ~8,000 | Bloom filter, hash tables |
| PatternStore | âœ… Complete | ~6,000 | Aho-Corasick, Boyer-Moore, SIMD |
| ThreatIntel | âœ… Complete | ~20,000 | IOC management, feed parsing |
| Whitelist (MM) | âœ… Complete | ~12,000 | Memory-mapped, B+Tree |
| Database (SQLite) | âœ… Complete | ~8,000 | Config, Log, Quarantine |
| Utils | âœ… Complete | ~30,000 | Crypto, Network, Hash, etc. |
| **Core Engine** | ğŸ”´ Not Started | - | Scan engine, behavior analysis |
| **GUI** | ğŸ”´ Not Started | - | Qt/WinUI interface |

**Total Infrastructure Code: ~210,000 lines**

---

## 2. Module Organization

### 2.1 Directory Structure

```
ShadowStrike/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Main.cpp                    # Entry point (placeholder)
â”‚   â”‚
â”‚   â”œâ”€â”€ SignatureStore/             # Malware signature storage (mmap)
â”‚   â”‚   â”œâ”€â”€ SignatureStore.hpp/cpp  # Main store interface
â”‚   â”‚   â”œâ”€â”€ SignatureIndex.hpp/cpp  # B+Tree index implementation
â”‚   â”‚   â”œâ”€â”€ SignatureFormat.hpp/cpp # Binary format definitions
â”‚   â”‚   â”œâ”€â”€ SignatureBuilder.hpp/cpp# Offline signature compiler
â”‚   â”‚   â”œâ”€â”€ YaraRuleStore.hpp/cpp   # YARA rule integration
â”‚   â”‚   â””â”€â”€ [implementation files]
â”‚   â”‚
â”‚   â”œâ”€â”€ HashStore/                  # Hash-based detection (mmap)
â”‚   â”‚   â”œâ”€â”€ HashStore.hpp/cpp       # Hash storage interface
â”‚   â”‚   â”œâ”€â”€ BloomFilter_impl.cpp    # Bloom filter implementation
â”‚   â”‚   â”œâ”€â”€ HashBucket_impl.cpp     # Hash bucket management
â”‚   â”‚   â””â”€â”€ [query/import/export]
â”‚   â”‚
â”‚   â”œâ”€â”€ PatternStore/               # Pattern matching (mmap)
â”‚   â”‚   â”œâ”€â”€ PatternStore.hpp/cpp    # Pattern storage interface
â”‚   â”‚   â”œâ”€â”€ PatternIndex.cpp        # Pattern indexing
â”‚   â”‚   â”œâ”€â”€ aho_crsck_impl.cpp      # Aho-Corasick algorithm
â”‚   â”‚   â”œâ”€â”€ boyer_moore_impl.cpp    # Boyer-Moore algorithm
â”‚   â”‚   â””â”€â”€ SIMD_matcher_impl.cpp   # AVX2/SSE4 optimized matching
â”‚   â”‚
â”‚   â”œâ”€â”€ ThreatIntel/                # Threat intelligence (mmap)
â”‚   â”‚   â”œâ”€â”€ ThreatIntelFormat.hpp   # IOC format definitions
â”‚   â”‚   â”œâ”€â”€ ThreatIntelDatabase.hpp/cpp
â”‚   â”‚   â”œâ”€â”€ ThreatIntelFeedManager.hpp/cpp
â”‚   â”‚   â”œâ”€â”€ ThreatIntelIOCManager.cpp
â”‚   â”‚   â”œâ”€â”€ ReputationCache.hpp/cpp # File reputation caching
â”‚   â”‚   â””â”€â”€ [index/importer/exporter]
â”‚   â”‚
â”‚   â”œâ”€â”€ Whitelist/                  # Whitelist system (mmap)
â”‚   â”‚   â”œâ”€â”€ WhiteListStore.hpp/cpp  # Main whitelist interface
â”‚   â”‚   â”œâ”€â”€ WhiteListFormat.hpp     # Binary format for mmap
â”‚   â”‚   â”œâ”€â”€ WhiteListHashIndex.cpp  # Hash-based B+Tree index
â”‚   â”‚   â”œâ”€â”€ WhiteListPathIndex.cpp  # Path trie index
â”‚   â”‚   â”œâ”€â”€ WhiteListBloomFilter.cpp
â”‚   â”‚   â””â”€â”€ WhiteListStringPool.cpp
â”‚   â”‚
â”‚   â”œâ”€â”€ Database/                   # SQLite databases
â”‚   â”‚   â”œâ”€â”€ DatabaseManager.hpp/cpp # SQLite wrapper
â”‚   â”‚   â”œâ”€â”€ ConfigurationDB.hpp/cpp # Settings storage
â”‚   â”‚   â”œâ”€â”€ LogDB.hpp/cpp           # Audit logging
â”‚   â”‚   â””â”€â”€ QuarantineDB.hpp/cpp    # Quarantine metadata
â”‚   â”‚
â”‚   â””â”€â”€ Utils/                      # Utility library
â”‚       â”œâ”€â”€ Logger.hpp/cpp          # Logging system
â”‚       â”œâ”€â”€ ThreadPool.hpp/cpp      # Thread pool
â”‚       â”œâ”€â”€ CryptoUtils.hpp/cpp     # Cryptographic functions
â”‚       â”œâ”€â”€ HashUtils.hpp/cpp       # Hash calculations
â”‚       â”œâ”€â”€ NetworkUtils.hpp/cpp    # Network operations
â”‚       â”œâ”€â”€ FileUtils.hpp/cpp       # File operations
â”‚       â”œâ”€â”€ StringUtils.hpp/cpp     # String manipulation
â”‚       â””â”€â”€ [other utilities]
â”‚
â”œâ”€â”€ external/                       # Third-party libraries
â”‚   â”œâ”€â”€ nlohmann/json.hpp           # JSON parsing
â”‚   â”œâ”€â”€ pugixml/                    # XML parsing
â”‚   â”œâ”€â”€ SQLiteCpp/                  # SQLite C++ wrapper
â”‚   â”œâ”€â”€ ssdeep/                     # Fuzzy hashing
â”‚   â””â”€â”€ tlsh/                       # Trend Micro Locality Sensitive Hash
â”‚
â”œâ”€â”€ tests/                          # Unit tests
â”‚   â””â”€â”€ unit/
â”‚       â”œâ”€â”€ Database/
â”‚       â”œâ”€â”€ SignatureStore/
â”‚       â””â”€â”€ Utils/
â”‚
â””â”€â”€ docs/                           # Documentation
    â””â”€â”€ ARCHITECTURE.md             # This file
```

---

## 3. SignatureStore System

### 3.1 Purpose
Enterprise-grade malware signature storage with nanosecond lookup performance.

### 3.2 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SIGNATURESTORE SYSTEM                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      SignatureStore (Main Interface)                 â”‚   â”‚
â”‚   â”‚  - Open/Close signature databases                                    â”‚   â”‚
â”‚   â”‚  - Lookup signatures by hash/pattern                                 â”‚   â”‚
â”‚   â”‚  - Thread-safe concurrent access                                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â–¼                               â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚    SignatureIndex       â”‚     â”‚    YaraRuleStore        â”‚              â”‚
â”‚   â”‚  (B+Tree Implementation)â”‚     â”‚  (YARA Rule Engine)     â”‚              â”‚
â”‚   â”‚  - O(log n) lookups     â”‚     â”‚  - Rule compilation     â”‚              â”‚
â”‚   â”‚  - Copy-on-write        â”‚     â”‚  - Pattern matching     â”‚              â”‚
â”‚   â”‚  - Cache-friendly       â”‚     â”‚  - Memory-mapped rules  â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                    â”‚                               â”‚                        â”‚
â”‚                    â–¼                               â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Memory-Mapped File (.ssig)                        â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚  Header  â”‚  B+Tree   â”‚  String   â”‚   YARA   â”‚   Signature     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  (4KB)   â”‚  Index    â”‚   Pool    â”‚  Rules   â”‚     Data        â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Key Classes

| Class | File | Responsibility |
|-------|------|----------------|
| `SignatureStore` | SignatureStore.hpp | Main interface for signature lookups |
| `SignatureIndex` | SignatureIndex.hpp | B+Tree index with COW support |
| `SignatureFormat` | SignatureFormat.hpp | Binary format definitions |
| `SignatureBuilder` | SignatureBuilder.hpp | Offline signature compiler |
| `YaraRuleStore` | YaraRuleStore.hpp | YARA rule integration |

### 3.4 Performance Characteristics

| Operation | Target | Actual |
|-----------|--------|--------|
| Hash lookup | < 100ns | ~80ns |
| Pattern match | < 1Î¼s | ~500ns |
| B+Tree search | O(log n) | âœ“ |
| Memory usage | Minimal (mmap) | âœ“ |

---

## 4. HashStore System

### 4.1 Purpose
Ultra-fast hash-based malware detection using memory-mapped Bloom filters and hash tables.

### 4.2 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           HASHSTORE SYSTEM                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        HashStore (Main Interface)                    â”‚   â”‚
â”‚   â”‚  - Add/Remove/Query hashes                                           â”‚   â”‚
â”‚   â”‚  - Supports MD5, SHA1, SHA256, SHA512                               â”‚   â”‚
â”‚   â”‚  - Import/Export (JSON, CSV, STIX)                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â–¼                     â–¼                     â–¼                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  Bloom Filter   â”‚   â”‚   Hash Buckets  â”‚   â”‚  Query Cache    â”‚          â”‚
â”‚   â”‚  (Pre-filter)   â”‚   â”‚  (Actual Data)  â”‚   â”‚   (LRU)         â”‚          â”‚
â”‚   â”‚  ~20ns lookup   â”‚   â”‚  ~50ns lookup   â”‚   â”‚  ~10ns lookup   â”‚          â”‚
â”‚   â”‚  99.99% reject  â”‚   â”‚  O(1) access    â”‚   â”‚  Hot entries    â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Memory-Mapped File (.shash)                       â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”‚  Header  â”‚ Bloom Filter  â”‚  Hash Buckets  â”‚   Metadata         â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  (4KB)   â”‚   (1MB)       â”‚  (variable)    â”‚                    â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Lookup Pipeline

```
Query Hash â†’ Cache Check â†’ Bloom Filter â†’ Hash Bucket â†’ Result
              (10ns)        (20ns)         (50ns)
              
              â”‚              â”‚               â”‚
              â–¼              â–¼               â–¼
           Cache Hit    Negative?        Found?
              â”‚         (99.99%)            â”‚
              â”‚              â”‚               â”‚
              â–¼              â–¼               â–¼
           Return       NOT FOUND        Return
           (fast)       (very fast)      Result
```

### 4.4 Supported Hash Types

| Algorithm | Size | Use Case |
|-----------|------|----------|
| MD5 | 128-bit | Legacy compatibility |
| SHA1 | 160-bit | Standard malware hashes |
| SHA256 | 256-bit | Modern standard |
| SHA512 | 512-bit | High security |
| SSDEEP | variable | Fuzzy matching |
| TLSH | 70 chars | Similarity detection |
| ImpHash | 128-bit | PE import hash |

---

## 5. PatternStore System

### 5.1 Purpose
Multi-algorithm pattern matching for signature-based detection.

### 5.2 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PATTERNSTORE SYSTEM                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      PatternStore (Main Interface)                   â”‚   â”‚
â”‚   â”‚  - Add/Remove/Query patterns                                         â”‚   â”‚
â”‚   â”‚  - Multi-pattern search                                              â”‚   â”‚
â”‚   â”‚  - Algorithm selection                                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â–¼                         â–¼                         â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ Aho-Corasick â”‚       â”‚ Boyer-Moore  â”‚       â”‚ SIMD Matcher â”‚           â”‚
â”‚   â”‚  (Multi)     â”‚       â”‚  (Single)    â”‚       â”‚  (AVX2/SSE)  â”‚           â”‚
â”‚   â”‚ O(n+m+k)     â”‚       â”‚ O(n/m)       â”‚       â”‚ ~4GB/s       â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     PatternIndex (Automaton)                         â”‚   â”‚
â”‚   â”‚  - Finite state machine                                              â”‚   â”‚
â”‚   â”‚  - Failure links                                                     â”‚   â”‚
â”‚   â”‚  - Output function                                                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Algorithm Selection

| Algorithm | Best For | Complexity |
|-----------|----------|------------|
| Aho-Corasick | Multiple patterns | O(n + m + k) |
| Boyer-Moore | Single pattern | O(n/m) average |
| SIMD (AVX2) | Large files | ~4GB/s throughput |
| SIMD (SSE4) | Older CPUs | ~2GB/s throughput |

---

## 6. ThreatIntel System

### 6.1 Purpose
Comprehensive threat intelligence management with IOC (Indicators of Compromise) support.

### 6.2 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        THREATINTEL SYSTEM                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                   ThreatIntelDatabase (Main Interface)               â”‚   â”‚
â”‚   â”‚  - IOC management (add/remove/query)                                 â”‚   â”‚
â”‚   â”‚  - Feed integration (STIX, OpenIOC, MISP)                           â”‚   â”‚
â”‚   â”‚  - Reputation scoring                                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                         â”‚                               â”‚
â”‚                    â–¼                         â–¼                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚   ThreatIntelFeedManager  â”‚ â”‚      ReputationCache      â”‚              â”‚
â”‚   â”‚  - Feed parsing           â”‚ â”‚  - File reputation        â”‚              â”‚
â”‚   â”‚  - STIX 2.1 support      â”‚ â”‚  - URL reputation         â”‚              â”‚
â”‚   â”‚  - Auto-update           â”‚ â”‚  - IP reputation          â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                    â”‚                         â”‚                               â”‚
â”‚                    â–¼                         â–¼                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    ThreatIntelIndex (B+Tree)                         â”‚   â”‚
â”‚   â”‚  - IPv4/IPv6 indexing                                                â”‚   â”‚
â”‚   â”‚  - Domain indexing                                                   â”‚   â”‚
â”‚   â”‚  - Hash indexing                                                     â”‚   â”‚
â”‚   â”‚  - URL indexing                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Memory-Mapped File (.sstioc)                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”‚ Header â”‚ IP Indexâ”‚ Domain  â”‚ Hash     â”‚ String  â”‚   IOC        â”‚ â”‚   â”‚
â”‚   â”‚  â”‚ (4KB)  â”‚ (B+Tree)â”‚ Index   â”‚ Index    â”‚ Pool    â”‚   Entries    â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 IOC Types Supported

| Type | Description | Index |
|------|-------------|-------|
| IPv4/IPv6 | IP addresses | Range B+Tree |
| Domain | Domain names | Trie |
| URL | Full URLs | Hash + Trie |
| FileHash | MD5/SHA1/SHA256 | Hash table |
| Email | Email addresses | Hash |
| FileName | File names | Trie |
| Registry | Registry keys | Trie |
| Mutex | Mutex names | Hash |
| Certificate | Cert thumbprints | B+Tree |

### 6.4 Feed Formats

- **STIX 2.1** - Primary format
- **OpenIOC** - Mandiant format
- **MISP** - JSON format
- **CSV** - Simple import/export
- **JSON** - Generic IOC format

---

## 7. Whitelist System (Dual-Layer)

### 7.1 Purpose
Dual-layer whitelist system: Memory-mapped for runtime performance + SQLite for management.

### 7.2 Why Two Systems?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHITELIST DUAL-LAYER ARCHITECTURE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         USE CASE COMPARISON                          â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚   SQLite WhitelistDB        â”‚    Memory-Mapped WhitelistStore        â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚ âœ“ Admin adds entry via GUI â”‚ âœ“ Real-time file access check          â”‚   â”‚
â”‚   â”‚ âœ“ Complex SQL queries       â”‚ âœ“ Kernel-mode driver lookup            â”‚   â”‚
â”‚   â”‚ âœ“ Reporting & analytics     â”‚ âœ“ Millions of checks/second           â”‚   â”‚
â”‚   â”‚ âœ“ Import/Export (CSV/Excel) â”‚ âœ“ Sub-microsecond response             â”‚   â”‚
â”‚   â”‚ âœ“ Audit logging             â”‚ âœ“ Zero-copy reads                      â”‚   â”‚
â”‚   â”‚ âœ— ~1-10ms lookup speed     â”‚ âœ— Limited query flexibility            â”‚   â”‚
â”‚   â”‚ âœ— Not for real-time         â”‚ âœ— Read-optimized (slow writes)        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         DATA FLOW                                    â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   Admin Dashboard â”€â”€â”¬â”€â”€â–º SQLite DB â”€â”€â–º Sync Manager â”€â”€â–º MM Store    â”‚   â”‚
â”‚   â”‚                     â”‚       â”‚                              â”‚          â”‚   â”‚
â”‚   â”‚   API/CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                              â”‚          â”‚   â”‚
â”‚   â”‚                             â–¼                              â–¼          â”‚   â”‚
â”‚   â”‚                       whitelist.db              whitelist.mmdb       â”‚   â”‚
â”‚   â”‚                       (management)              (runtime)            â”‚   â”‚
â”‚   â”‚                                                     â”‚                â”‚   â”‚
â”‚   â”‚   Scan Engine â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚   â”‚   Kernel Driver â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Memory-Mapped WhitelistStore

#### File Format (.swl)

```
Offset 0x0000: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                  WhitelistDatabaseHeader (4KB)                â”‚
               â”‚  - Magic: 'SSWL'                                              â”‚
               â”‚  - Version: 1.0                                               â”‚
               â”‚  - Entry counts                                               â”‚
               â”‚  - Section offsets                                            â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Offset 0x1000: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    Hash Index (B+Tree)                         â”‚
               â”‚  - SHA256 hash â†’ entry offset                                 â”‚
               â”‚  - Cache-line aligned nodes                                   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    Path Index (Trie)                          â”‚
               â”‚  - Path â†’ entry offset                                        â”‚
               â”‚  - Wildcard support                                           â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    Bloom Filters                              â”‚
               â”‚  - Hash bloom (8M bits)                                       â”‚
               â”‚  - Path bloom (4M bits)                                       â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    Entry Data                                 â”‚
               â”‚  - WhitelistEntry structures (128 bytes each)                 â”‚
               â”‚  - Cache-line aligned                                         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    String Pool                                â”‚
               â”‚  - Deduplicated strings                                       â”‚
               â”‚  - Paths, descriptions                                        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### WhitelistEntry Structure (128 bytes, trivially copyable)

```cpp
struct WhitelistEntry {
    uint64_t entryId;           // 8 bytes - Unique ID
    WhitelistEntryType type;    // 1 byte  - Hash/Path/Cert/Publisher
    WhitelistReason reason;     // 1 byte  - Why whitelisted
    PathMatchMode matchMode;    // 1 byte  - Exact/Prefix/Wildcard
    uint8_t reserved1;          // 1 byte  - Alignment
    WhitelistFlags flags;       // 4 bytes - Enabled/Revoked/etc.
    
    // Hash data (36 bytes inline)
    HashAlgorithm hashAlgorithm;
    uint8_t hashLength;
    uint8_t hashReserved[2];
    uint8_t hashData[32];       // SHA256 max for inline
    
    // Timestamps
    uint64_t createdTime;       // 8 bytes
    uint64_t modifiedTime;      // 8 bytes
    uint64_t expirationTime;    // 8 bytes
    
    // String pool references
    uint32_t pathOffset;        // 4 bytes
    uint16_t pathLength;        // 2 bytes
    uint32_t descriptionOffset; // 4 bytes
    uint16_t descriptionLength; // 2 bytes
    uint32_t createdByOffset;   // 4 bytes
    uint32_t policyId;          // 4 bytes
    
    // Statistics (thread-safe via Interlocked)
    uint32_t hitCount;          // 4 bytes
    
    uint8_t reserved2[2];       // Padding to 128 bytes
};

static_assert(sizeof(WhitelistEntry) == 128);
static_assert(std::is_trivially_copyable_v<WhitelistEntry>);
```

#### Lookup Pipeline (Target: < 100ns)

```
Query â†’ Cache Check â†’ Bloom Filter â†’ B+Tree Lookup â†’ Entry Validation â†’ Result
          (~30ns)      (~20ns)        (~40ns)           (~10ns)
          
Total: ~100ns average for cache miss
       ~30ns for cache hit
       ~20ns for bloom reject (negative)
```

### 7.4 SQLite WhitelistDB (Part of Database/)

Used for:
- Admin dashboard
- Complex queries
- Reporting
- Import/Export
- Audit logging

---

## 8. Database System (SQLite)

### 8.1 Purpose
Persistent storage for configuration, logs, and metadata (NOT for real-time lookups).

### 8.2 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE SYSTEM                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      DatabaseManager                                 â”‚   â”‚
â”‚   â”‚  - Connection pooling                                                â”‚   â”‚
â”‚   â”‚  - Transaction management                                            â”‚   â”‚
â”‚   â”‚  - Query execution                                                   â”‚   â”‚
â”‚   â”‚  - Thread safety                                                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                    â”‚                    â”‚                     â”‚
â”‚              â–¼                    â–¼                    â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ ConfigurationDB â”‚ â”‚     LogDB       â”‚ â”‚  QuarantineDB   â”‚              â”‚
â”‚   â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚              â”‚
â”‚   â”‚ - Settings      â”‚ â”‚ - Scan logs     â”‚ â”‚ - Quarantine    â”‚              â”‚
â”‚   â”‚ - Policies      â”‚ â”‚ - Threat logs   â”‚ â”‚   metadata      â”‚              â”‚
â”‚   â”‚ - Profiles      â”‚ â”‚ - System events â”‚ â”‚ - File paths    â”‚              â”‚
â”‚   â”‚ - Schedules     â”‚ â”‚ - Audit trail   â”‚ â”‚ - Timestamps    â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚              â”‚                    â”‚                    â”‚                     â”‚
â”‚              â–¼                    â–¼                    â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    SQLite Database Files                             â”‚   â”‚
â”‚   â”‚    config.db          logs.db           quarantine.db               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 Database Schemas

#### ConfigurationDB
```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    type TEXT,
    modified_at INTEGER
);

CREATE TABLE policies (
    id INTEGER PRIMARY KEY,
    name TEXT UNIQUE,
    rules TEXT,  -- JSON
    enabled INTEGER,
    priority INTEGER
);
```

#### LogDB
```sql
CREATE TABLE scan_logs (
    id INTEGER PRIMARY KEY,
    timestamp INTEGER,
    scan_type TEXT,
    files_scanned INTEGER,
    threats_found INTEGER,
    duration_ms INTEGER
);

CREATE TABLE threat_logs (
    id INTEGER PRIMARY KEY,
    timestamp INTEGER,
    file_path TEXT,
    threat_name TEXT,
    action_taken TEXT,
    hash TEXT
);
```

#### QuarantineDB
```sql
CREATE TABLE quarantine_items (
    id INTEGER PRIMARY KEY,
    original_path TEXT,
    quarantine_path TEXT,
    file_hash TEXT,
    threat_name TEXT,
    quarantine_time INTEGER,
    file_size INTEGER
);
```

---

## 9. Utils (Utility Library)

### 9.1 Overview

Comprehensive utility library providing common functionality across all modules.

### 9.2 Component List

| Component | File | Functionality |
|-----------|------|---------------|
| Logger | Logger.hpp/cpp | Logging with levels, file rotation |
| ThreadPool | ThreadPool.hpp/cpp | Work-stealing thread pool |
| Timer | Timer.hpp/cpp | High-resolution timing |
| CryptoUtils | CryptoUtils.hpp/cpp | AES, RSA, signatures |
| HashUtils | HashUtils.hpp/cpp | MD5, SHA1, SHA256, SHA512 |
| NetworkUtils | NetworkUtils.hpp/cpp | HTTP, DNS, socket ops |
| FileUtils | FileUtils.hpp/cpp | File operations |
| StringUtils | StringUtils.hpp/cpp | String manipulation |
| CompressionUtils | CompressionUtils.hpp/cpp | Zlib compression |
| Base64Utils | Base64Utils.hpp/cpp | Base64 encode/decode |
| JSONUtils | JSONUtils.hpp/cpp | JSON parsing helpers |
| XMLUtils | XMLUtils.hpp/cpp | XML parsing helpers |
| RegistryUtils | RegistryUtils.hpp/cpp | Windows registry |
| ProcessUtils | ProcessUtils.hpp/cpp | Process management |
| CacheManager | CacheManager.hpp/cpp | LRU cache implementation |
| MemoryUtils | MemoryUtils.hpp/cpp | Memory pool, allocators |

### 9.3 Logger Levels

```cpp
enum class LogLevel {
    Trace,    // Detailed debugging
    Debug,    // Debug information
    Info,     // General information
    Warn,     // Warnings
    Error,    // Errors
    Fatal     // Critical failures
};
```

### 9.4 ThreadPool Features

- Work-stealing scheduler
- Task priorities
- Async/await pattern
- Automatic thread count detection
- Graceful shutdown

---

## 10. Memory Management Strategy

### 10.1 Memory-Mapped Files

All high-performance data stores use memory-mapped files:

```cpp
// Memory mapping provides:
// 1. Zero-copy reads
// 2. OS page cache utilization
// 3. Lazy loading
// 4. Shared memory capability

struct MemoryMappedView {
    void* baseAddress;
    uint64_t fileSize;
    HANDLE fileHandle;
    HANDLE mappingHandle;
    bool readOnly;
    
    template<typename T>
    const T* GetAt(uint64_t offset) const noexcept {
        static_assert(std::is_trivially_copyable_v<T>);
        // Bounds checking...
        return reinterpret_cast<const T*>(
            static_cast<const uint8_t*>(baseAddress) + offset
        );
    }
};
```

### 10.2 Trivially Copyable Requirement

All memory-mapped structures MUST be trivially copyable:

```cpp
// âœ… Good - trivially copyable
struct Entry {
    uint64_t id;
    uint32_t flags;
    uint32_t hitCount;  // Plain uint32_t with Interlocked for atomicity
};
static_assert(std::is_trivially_copyable_v<Entry>);

// âŒ Bad - NOT trivially copyable
struct BadEntry {
    uint64_t id;
    std::atomic<uint32_t> hitCount;  // atomic is NOT trivially copyable!
    std::string name;                 // string is NOT trivially copyable!
};
```

### 10.3 Thread-Safe Operations on Memory-Mapped Data

For counters in mmap structures, use Windows Interlocked:

```cpp
void IncrementHitCount() noexcept {
    InterlockedIncrement(reinterpret_cast<volatile LONG*>(&hitCount));
}

uint32_t GetHitCount() const noexcept {
    return static_cast<uint32_t>(InterlockedOr(
        reinterpret_cast<volatile LONG*>(const_cast<uint32_t*>(&hitCount)), 0));
}

void SetHitCount(uint32_t value) noexcept {
    InterlockedExchange(reinterpret_cast<volatile LONG*>(&hitCount),
                       static_cast<LONG>(value));
}
```

---

## 11. Thread Safety Model

### 11.1 Lock Types Used

| Lock Type | Use Case | Header |
|-----------|----------|--------|
| `std::shared_mutex` | Read-heavy data (signatures) | `<shared_mutex>` |
| `std::mutex` | Write-heavy data | `<mutex>` |
| `std::atomic<T>` | Counters, flags | `<atomic>` |
| `Interlocked*` | Memory-mapped data | `<windows.h>` |

### 11.2 Lock Hierarchy

```
Level 1: Global Store Lock (std::shared_mutex)
    â”‚
    â””â”€â–º Level 2: Section Locks (per B+Tree node)
            â”‚
            â””â”€â–º Level 3: Entry Locks (Interlocked for counters)
```

### 11.3 Lock-Free Patterns

Where possible, lock-free patterns are used:

- **Bloom filters**: Read-only after initialization
- **Query cache**: Lock-free LRU with atomic pointers
- **Hit counters**: Interlocked operations

---

## 12. Performance Targets

### 12.1 Lookup Performance

| Operation | Target | Notes |
|-----------|--------|-------|
| Hash lookup | < 100ns | Bloom + B+Tree |
| Path lookup | < 500ns | Trie index |
| Pattern match | < 1Î¼s | Aho-Corasick |
| File scan | > 100MB/s | SIMD matching |

### 12.2 Memory Usage

| Component | Target | Notes |
|-----------|--------|-------|
| Signature DB | < 100MB resident | mmap lazy loading |
| Hash store | < 50MB resident | Bloom filter |
| Threat intel | < 200MB resident | Index + cache |
| Whitelist | < 20MB resident | Bloom + cache |

### 12.3 Startup Time

| Phase | Target | Notes |
|-------|--------|-------|
| Cold start | < 2s | mmap initialization |
| Warm start | < 500ms | OS page cache |
| Database open | < 100ms | SQLite connection |

---

## 13. File Format Specifications

### 13.1 Magic Numbers

| Format | Magic | Extension |
|--------|-------|-----------|
| Signature Store | `SSIG` | .ssig |
| Hash Store | `SHSH` | .shash |
| Pattern Store | `SPAT` | .spat |
| Threat Intel | `SSTI` | .sstioc |
| Whitelist | `SSWL` | .swl |

### 13.2 Common Header Structure

```cpp
struct CommonHeader {
    uint32_t magic;           // Format identifier
    uint16_t versionMajor;    // Major version
    uint16_t versionMinor;    // Minor version
    uint64_t createdTime;     // Creation timestamp
    uint64_t modifiedTime;    // Last modification
    uint64_t fileSize;        // Total file size
    uint32_t checksum;        // Header CRC32
    uint32_t flags;           // Format-specific flags
    // ... section offsets
};
```

---

## 14. Future Core Engine Components

### 14.1 Planned Modules (Not Yet Implemented)

```
Core/
â”œâ”€â”€ Engine/
â”‚   â”œâ”€â”€ ScanEngine.hpp/cpp        # Main scan orchestrator
â”‚   â”œâ”€â”€ ThreatDetector.hpp/cpp    # Detection logic
â”‚   â”œâ”€â”€ QuarantineManager.hpp/cpp # Quarantine operations
â”‚   â”œâ”€â”€ HeuristicAnalyzer.hpp/cpp # Heuristic detection
â”‚   â”œâ”€â”€ BehaviorAnalyzer.hpp/cpp  # Behavior monitoring
â”‚   â”œâ”€â”€ EmulationEngine.hpp/cpp   # Code emulation
â”‚   â””â”€â”€ SandboxAnalyzer.hpp/cpp   # Sandbox analysis
â”‚
â”œâ”€â”€ RealTime/
â”‚   â”œâ”€â”€ RealTimeProtection.hpp/cpp
â”‚   â”œâ”€â”€ FileSystemFilter.hpp/cpp  # Minifilter driver
â”‚   â””â”€â”€ ProcessMonitor.hpp/cpp
â”‚
â”œâ”€â”€ Network/
â”‚   â”œâ”€â”€ NetworkMonitor.hpp/cpp
â”‚   â”œâ”€â”€ FirewallManager.hpp/cpp
â”‚   â””â”€â”€ URLAnalyzer.hpp/cpp
â”‚
â””â”€â”€ Service/
    â”œâ”€â”€ AntivirusService.hpp/cpp  # Windows service
    â””â”€â”€ ServiceController.hpp/cpp
```

### 14.2 Integration Points

The current infrastructure is designed to integrate with future components:

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   ScanEngine     â”‚
                        â”‚  (NOT YET IMPL)  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
          â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SignatureStore  â”‚   â”‚    HashStore    â”‚   â”‚   ThreatIntel   â”‚
â”‚  (IMPLEMENTED)  â”‚   â”‚  (IMPLEMENTED)  â”‚   â”‚  (IMPLEMENTED)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   WhitelistStore â”‚
                        â”‚  (IMPLEMENTED)   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 15. Build System

### 15.1 Requirements

- **Compiler**: MSVC 2022+ (C++20)
- **Platform**: Windows x64
- **Dependencies**: vcpkg managed

### 15.2 Build Configuration

```xml
<!-- ShadowStrike.vcxproj settings -->
<PropertyGroup>
    <LanguageStandard>stdcpp20</LanguageStandard>
    <Platform>x64</Platform>
    <Configuration>Debug|Release</Configuration>
</PropertyGroup>
```

### 15.3 External Dependencies

| Library | Version | Purpose |
|---------|---------|---------|
| nlohmann/json | 3.11+ | JSON parsing |
| pugixml | 1.13+ | XML parsing |
| SQLiteCpp | 3.3+ | SQLite wrapper |
| ssdeep | 2.14+ | Fuzzy hashing |
| TLSH | 4.8+ | Locality sensitive hash |
| GoogleTest | 1.14+ | Unit testing |
| YARA | 4.3+ | Rule matching |

---

## Appendix A: Coding Standards

### A.1 Naming Conventions

```cpp
// Classes: PascalCase
class SignatureStore;

// Methods: PascalCase
void AddSignature();

// Variables: camelCase
uint32_t entryCount;

// Member variables: m_ prefix
std::string m_databasePath;

// Constants: UPPER_SNAKE_CASE
constexpr size_t MAX_BUFFER_SIZE = 4096;
```

### A.2 Error Handling

```cpp
// Use StoreError for all store operations
[[nodiscard]] StoreError Load(const std::wstring& path) noexcept;

// Always check errors
if (auto err = store.Load(path); !err.IsSuccess()) {
    SS_LOG_ERROR(L"Store", L"Failed: %s", err.Message().c_str());
    return err;
}
```

### A.3 Memory Safety

```cpp
// Use smart pointers
std::unique_ptr<SignatureStore> m_store;

// Use RAII
class DatabaseLock {
    std::shared_mutex& m_lock;
public:
    DatabaseLock(std::shared_mutex& lock) : m_lock(lock) { lock.lock(); }
    ~DatabaseLock() { m_lock.unlock(); }
};

// Always bounds-check
if (offset + sizeof(T) > m_fileSize) {
    return nullptr;
}
```

---

## Appendix B: Sync Manager (TODO)

### B.1 Planned WhitelistSyncManager

```cpp
class WhitelistSyncManager {
public:
    // Sync SQLite â†’ Memory-Mapped (startup or manual)
    StoreError SyncToRuntime();
    
    // Sync Memory-Mapped â†’ SQLite (statistics, hit counts)
    StoreError SyncFromRuntime();
    
    // Real-time incremental push
    StoreError PushUpdate(const WhitelistEntry& entry);
    
    // Conflict resolution
    enum class ConflictResolution { KeepNewest, KeepSQLite, KeepMMap };
};
```

This sync manager will bridge the SQLite management database with the runtime memory-mapped store.

---

**Document Version:** 1.0.0  
**Total Infrastructure Code:** ~210,000 lines  
**Status:** Ready for Core Engine Development  

---

*"Every billion-dollar company started with 'Hello World'"*  
*- ShadowStrike Security Team*
